name: Create PR to sync source branch to target branch

on:
  workflow_call:
    inputs:
      source_branch:
        description: 'ãƒžãƒ¼ã‚¸å…ƒãƒ–ãƒ©ãƒ³ãƒå'
        type: string
        required: true
      target_branch:
        description: 'ãƒžãƒ¼ã‚¸å…ˆãƒ–ãƒ©ãƒ³ãƒå'
        type: string
        required: true
      repository:
        description: 'å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª (owner/repo)'
        type: string
        required: false
        default: ''
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'ãƒžãƒ¼ã‚¸å…ƒãƒ–ãƒ©ãƒ³ãƒå'
        type: string
        required: true
      target_branch:
        description: 'ãƒžãƒ¼ã‚¸å…ˆãƒ–ãƒ©ãƒ³ãƒå'
        type: string
        required: true
      repository:
        description: 'å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª (owner/repo)'
        type: string
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

env:
  GIT_USER_NAME: "github-actions[bot]"
  GIT_USER_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"

jobs:
  create-pr:
    name: Create PR (${{ inputs.source_branch }} â†’ ${{ inputs.target_branch }})
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ inputs.repository || github.repository }}

      - name: Checkout workflow templates
        uses: actions/checkout@v4
        with:
          repository: lepusinc/.github
          ref: main
          path: _workflow_templates
          sparse-checkout: |
            .github/PULL_REQUEST_TEMPLATE
            .github/workflow-templates
          sparse-checkout-cone-mode: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "${{ env.GIT_USER_NAME }}"
          git config user.email "${{ env.GIT_USER_EMAIL }}"

      - name: Create sync branch
        env:
          COMMIT_SHA: ${{ github.sha }}
          SOURCE_BRANCH: ${{ inputs.source_branch }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
        run: |
          git fetch origin "${SOURCE_BRANCH}"
          BRANCH="sync/${SOURCE_BRANCH}-to-${TARGET_BRANCH}-${COMMIT_SHA}"
          echo "BRANCH=${BRANCH}" >> $GITHUB_ENV

          if git ls-remote --heads origin "${BRANCH}" | grep -q .; then
            git fetch origin "${BRANCH}"
          fi
          git checkout -B "${BRANCH}" origin/${SOURCE_BRANCH}
          git push --force-with-lease origin "${BRANCH}"

      - name: Create Pull Request
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          SOURCE_BRANCH: ${{ inputs.source_branch }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          REPOSITORY: ${{ inputs.repository || github.repository }}
        run: |
          COMMIT_TITLE=$(printf '%s\n' "${COMMIT_MESSAGE}" \
            | sed -n '/[^[:space:]]/,$p' \
            | head -n 1 \
            | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
          [ -z "${COMMIT_TITLE}" ] && COMMIT_TITLE="(no commit title)"

          PR_TITLE="ðŸ”„ Sync ${SOURCE_BRANCH} to ${TARGET_BRANCH} - ${COMMIT_TITLE}"
          PR_TITLE="${PR_TITLE:0:256}"

          PR_BODY=$(envsubst '${SOURCE_BRANCH} ${TARGET_BRANCH} ${COMMIT_SHA} ${COMMIT_MESSAGE}' \
            < _workflow_templates/.github/PULL_REQUEST_TEMPLATE/sync.md)

          PR_URL=$(gh pr create \
            --repo "${REPOSITORY}" \
            --base "${TARGET_BRANCH}" \
            --head "${BRANCH}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}" \
            2>/tmp/pr_create_err.txt)
          CREATE_STATUS=$?

          if [ "${CREATE_STATUS}" -eq 0 ]; then
            echo "pull-request-url=${PR_URL}" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_CREATE_ERR=$(cat /tmp/pr_create_err.txt)
          if echo "${PR_CREATE_ERR}" | grep -q "already exists"; then
            echo "::notice::PR already exists for ${BRANCH}."
            PR_URL=$(gh pr view "${BRANCH}" --repo "${REPOSITORY}" --json url --jq '.url')
            echo "pull-request-url=${PR_URL}" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "::error::gh pr create failed (exit ${CREATE_STATUS}): ${PR_CREATE_ERR}"
          exit 1

      - name: Add labels to PR
        id: add_labels
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ steps.create_pr.outputs.pull-request-url }}
        run: |
          LABELS="sync,automated"
          LABEL_OUTPUT=$(gh pr edit "${PR_URL}" --add-label "${LABELS}" 2>&1) && LABEL_STATUS=0 || LABEL_STATUS=$?

          echo "labels=${LABELS}" >> $GITHUB_OUTPUT
          if [ "${LABEL_STATUS}" -eq 0 ]; then
            echo "label-status=success" >> $GITHUB_OUTPUT
          else
            echo "::warning::Failed to add labels to PR: ${PR_URL}"
            echo "label-status=failure" >> $GITHUB_OUTPUT
            {
              echo 'label-error<<LABEL_ERROR_EOF'
              echo "${LABEL_OUTPUT}"
              echo 'LABEL_ERROR_EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: Output summary
        if: success()
        env:
          PR_URL: ${{ steps.create_pr.outputs.pull-request-url }}
          SOURCE_BRANCH: ${{ inputs.source_branch }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
        run: |
          envsubst '${SOURCE_BRANCH} ${TARGET_BRANCH} ${PR_URL}' \
            < _workflow_templates/.github/workflow-templates/pr-created.md \
            >> $GITHUB_STEP_SUMMARY

      - name: Output failure summary
        if: failure()
        env:
          SOURCE_BRANCH: ${{ inputs.source_branch }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
        run: |
          envsubst '${SOURCE_BRANCH} ${TARGET_BRANCH}' \
            < _workflow_templates/.github/workflow-templates/pr-creation-failed.md \
            >> $GITHUB_STEP_SUMMARY
