name: Create pull request to sync
run-name: Create pull request to sync. (${{ github.ref_name }} -> ${{ inputs.target_branch }})

on:
  workflow_call:
    inputs:
      target_branch:
        description: "„Éû„Éº„Ç∏ÂÖà„Éñ„É©„É≥„ÉÅÂêç"
        type: string
        required: true
  workflow_dispatch:
    inputs:
      target_branch:
        description: "„Éû„Éº„Ç∏ÂÖà„Éñ„É©„É≥„ÉÅÂêç"
        type: string
        required: true
        default: "test-sync-target"

permissions:
  contents: write
  pull-requests: write

jobs:
  workflow-template-artifact:
    name: Upload workflow template artifact
    runs-on: ubuntu-latest
    env:
      WORKFLOW_TEMPLATES_PATH: _workflow_templates
      ARTIFACT_NAME: workflow-templates
    outputs:
      name: ${{ env.ARTIFACT_NAME }}
    steps:
      - name: Extract template source
        id: extract_template_source
        env:
          WORKFLOW_REF: ${{ github.workflow_ref }}
        run: |
          TEMPLATE_REPOSITORY="${WORKFLOW_REF%%/.github/workflows/*}"
          TEMPLATE_REF="${WORKFLOW_REF##*@}"

          echo "### Template Source" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "repository=${TEMPLATE_REPOSITORY}" | tee -a "$GITHUB_STEP_SUMMARY" | tee -a "$GITHUB_OUTPUT"
          echo "ref=${TEMPLATE_REF}" | tee -a "$GITHUB_STEP_SUMMARY" | tee -a "$GITHUB_OUTPUT"

      - name: Cache templates
        id: cache_templates
        uses: actions/cache@v5
        with:
          path: ${{ env.WORKFLOW_TEMPLATES_PATH }}
          key: workflow-templates-${{ github.workflow_sha }}

      - name: Cache Result
        id: cache_result
        env:
          CACHE_HIT: ${{ steps.cache_templates.outputs.cache-hit }}
        run: |
          echo "### Cache" | tee -a "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.cache_templates.outputs.cache-hit }}" = "true" ]; then
            MESSAGE="Cache was used."
          else
            MESSAGE="Cache was not used."
          fi
          echo "$MESSAGE" | tee -a "$GITHUB_STEP_SUMMARY"

      - name: Checkout templates
        if: steps.cache_templates.outputs.cache-hit != 'true'
        uses: actions/checkout@v6
        with:
          repository: ${{ steps.extract_template_source.outputs.repository }}
          ref: ${{ steps.extract_template_source.outputs.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: ${{ env.WORKFLOW_TEMPLATES_PATH }}
          sparse-checkout: |
            .github/PULL_REQUEST_TEMPLATE
            .github/workflow-templates
            .github/matchers
          sparse-checkout-cone-mode: false

      - name: Upload Artifact
        id: upload_artifact
        uses: actions/upload-artifact@v7
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: "${{ env.WORKFLOW_TEMPLATES_PATH }}/.github"
          include-hidden-files: true
          retention-days: 1

      - name: Upload Artifact Result
        if: success()
        run: |
          echo "### Upload Artifact" | tee -a "$GITHUB_STEP_SUMMARY"
          cat <<EOF | tee -a "$GITHUB_STEP_SUMMARY"
          | Key | Value |
          | --- | ----- |
          | artifact-id | ${{ steps.upload_artifact.outputs.artifact-id }} |
          | artifact-url | ${{ steps.upload_artifact.outputs.artifact-url }} |
          | artifact-digest | ${{ steps.upload_artifact.outputs.artifact-digest }} |
          EOF

          echo "## Output" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "name=${{ env.ARTIFACT_NAME }}" | tee -a "$GITHUB_STEP_SUMMARY" | tee -a "$GITHUB_OUTPUT"

  create-pr:
    name: Create pull request
    runs-on: ubuntu-latest
    needs: workflow-template-artifact
    if: success()
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download workflow templates
        id: download_templates
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.workflow-template-artifact.outputs.name }}
          path: _workflow_templates

      - name: Download Artifact Result
        if: success()
        env:
          TEMPLATES_PATH: ${{ steps.download_templates.outputs.download-path }}
        run: |
          echo "### Download Artifact" | tee -a "$GITHUB_STEP_SUMMARY"
          cat <<EOF | tee -a "$GITHUB_STEP_SUMMARY"
          | Key | Value |
          | --- | ----- |
          | download-path | "${TEMPLATES_PATH}" |
          EOF
          tree -a -L 3 "${TEMPLATES_PATH}"

      - name: Register markdown alert problem matcher
        env:
          TEMPLATES_PATH: ${{ steps.download_templates.outputs.download-path }}
        shell: bash
        run: |
          set -euo pipefail
          MATCHER_PATH="${TEMPLATES_PATH}/matchers/markdown-alerts.json"

          if [[ ! -f "$MATCHER_PATH" ]]; then
            echo "::warning::Matcher not found (skipping): $MATCHER_PATH" >&2
            exit 0
          fi

          echo "$MATCHER_PATH" >> "$GITHUB_MATCHER"

      - name: Create sync branch
        id: create_sync_branch
        env:
          SOURCE_BRANCH: ${{ github.ref_name }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          BRANCH: "sync/${{ github.ref_name }}-to-${{ inputs.target_branch }}"
        run: |
          echo "Fetching source branch: ${SOURCE_BRANCH}"
          git fetch origin "${SOURCE_BRANCH}"

          if git ls-remote --heads origin "${BRANCH}" | grep -q .; then
            echo "Sync branch exists, fetching: ${BRANCH}"
            git fetch origin "${BRANCH}"
          else
            echo "Sync branch does not exist: ${BRANCH}"
          fi

          echo "Creating sync branch: ${BRANCH}"
          git checkout -B "${BRANCH}" origin/${SOURCE_BRANCH}

          if ! git push --force-with-lease origin "${BRANCH}"; then
            cat <<'ALERT'
          > [!CAUTION]
          > Failed to push sync branch: ${BRANCH}
          ALERT
            exit 1
          fi

          echo "### Create Sync Branch" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "branch=${BRANCH}" | tee -a "$GITHUB_STEP_SUMMARY" | tee -a "$GITHUB_OUTPUT"

      - name: Check Existing PR
        id: check_existing_pr
        env:
          BRANCH: ${{ steps.create_sync_branch.outputs.branch }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for existing PR on branch: ${BRANCH}"

          EXISTING_PR_OUTPUT=""
          EXISTING_PR=""
          set +e
          EXISTING_PR_OUTPUT=$(gh pr view "${BRANCH}" --repo "${{ github.repository }}" --json url --jq '.url' 2>&1)
          EXIT_CODE=$?
          set -e

          echo "gh pr view output: $EXISTING_PR_OUTPUT"

          echo "### Check Existing PR" | tee -a "$GITHUB_STEP_SUMMARY"
          if [ $EXIT_CODE -eq 0 ]; then
            EXISTING_PR="$EXISTING_PR_OUTPUT"
            cat <<ALERT
          > [!NOTE]
          > PR already exists for ${BRANCH}: $EXISTING_PR
          ALERT
            echo "pull-request-url=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            cat <<ALERT
          > [!WARNING]
          > No existing PR found (exit code $EXIT_CODE)
          ALERT
          fi

      - name: Create Pull Request
        id: create_pr
        if: steps.check_existing_pr.outputs.pull-request-url == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          SOURCE_BRANCH: ${{ github.ref_name }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          BRANCH: ${{ steps.create_sync_branch.outputs.branch }}
          TEMPLATES_PATH: ${{ steps.download_templates.outputs.download-path }}
        run: |
          echo "Extracting commit title from commit message"
          COMMIT_TITLE=$(printf '%s\n' "${COMMIT_MESSAGE}" \
            | sed -n '/[^[:space:]]/,$p' \
            | head -n 1 \
            | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
          [ -z "${COMMIT_TITLE}" ] && COMMIT_TITLE="(no commit title)"
          echo "Commit title: ${COMMIT_TITLE}"

          PR_TITLE="üîÑ Sync ${SOURCE_BRANCH} to ${TARGET_BRANCH} - ${COMMIT_TITLE}"
          PR_TITLE="${PR_TITLE:0:256}"
          echo "PR title: ${PR_TITLE}"

          echo "Loading PR body template"
          if ! PR_BODY=$(envsubst < "${TEMPLATES_PATH}/PULL_REQUEST_TEMPLATE/sync.md"); then
            cat <<'ALERT'
          > [!CAUTION]
          > Failed to load PR body template
          ALERT
            exit 1
          fi

          echo "Creating pull request"
          if ! PR_URL=$(gh pr create \
            --repo "${{ github.repository }}" \
            --base "${TARGET_BRANCH}" \
            --head "${BRANCH}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}"); then
            cat <<'ALERT'
          > [!CAUTION]
          > Failed to create pull request
          ALERT
            exit 1
          fi

          echo "PR created: ${PR_URL}"

          echo "### Create Pull Request" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "pull-request-url=${PR_URL}" | tee -a "$GITHUB_STEP_SUMMARY" | tee -a "$GITHUB_OUTPUT"

      - name: Add labels to PR
        id: add_labels
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ steps.check_existing_pr.outputs.pull-request-url || steps.create_pr.outputs.pull-request-url }}
        run: |
          LABELS="sync,automated"
          echo "Adding labels to PR: ${LABELS}"
          echo "Target PR: ${PR_URL}"

          LABEL_OUTPUT=$(gh pr edit "${PR_URL}" --add-label "${LABELS}" 2>&1) && LABEL_STATUS=0 || LABEL_STATUS=$?

          echo "gh pr edit output: ${LABEL_OUTPUT}"

          echo "### Add Labels to PR" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "labels=${LABELS}" | tee -a "$GITHUB_OUTPUT"
          if [ "${LABEL_STATUS}" -eq 0 ]; then
            echo "Labels added successfully: ${LABELS}" | tee -a "$GITHUB_STEP_SUMMARY"
            echo "label-status=success" >> $GITHUB_OUTPUT
          else
            cat <<ALERT
          > [!WARNING]
          > Failed to add labels to PR: ${PR_URL} (exit code ${LABEL_STATUS})
          ALERT
            echo "label-status=failure" >> $GITHUB_OUTPUT
            {
              echo 'label-error<<LABEL_ERROR_EOF'
              echo "${LABEL_OUTPUT}"
              echo 'LABEL_ERROR_EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: Output summary
        if: success()
        env:
          SOURCE_BRANCH: ${{ github.ref_name }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          TEMPLATES_PATH: ${{ steps.download_templates.outputs.download-path }}
          PR_URL: ${{ steps.check_existing_pr.outputs.pull-request-url || steps.create_pr.outputs.pull-request-url }}
        run: |
          envsubst < "${TEMPLATES_PATH}/workflow-templates/pr-created.md" >> $GITHUB_STEP_SUMMARY

      - name: Output failure summary
        if: failure()
        env:
          SOURCE_BRANCH: ${{ github.ref_name }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          TEMPLATES_PATH: ${{ steps.download_templates.outputs.download-path }}
        run: |
          envsubst < "${TEMPLATES_PATH}/workflow-templates/pr-creation-failed.md" >> $GITHUB_STEP_SUMMARY
