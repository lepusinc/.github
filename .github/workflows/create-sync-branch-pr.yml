name: Create PR to sync source branch to target branch

on:
  workflow_call:
    inputs:
      source_branch:
        description: 'ãƒžãƒ¼ã‚¸å…ƒãƒ–ãƒ©ãƒ³ãƒå'
        type: string
        required: true
      target_branch:
        description: 'ãƒžãƒ¼ã‚¸å…ˆãƒ–ãƒ©ãƒ³ãƒå'
        type: string
        required: true
      repository:
        description: 'å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª (owner/repo)'
        type: string
        required: false
        default: ''
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'ãƒžãƒ¼ã‚¸å…ƒãƒ–ãƒ©ãƒ³ãƒå'
        type: string
        required: true
      target_branch:
        description: 'ãƒžãƒ¼ã‚¸å…ˆãƒ–ãƒ©ãƒ³ãƒå'
        type: string
        required: true
      repository:
        description: 'å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª (owner/repo)'
        type: string
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

env:
  GIT_USER_NAME: "github-actions[bot]"
  GIT_USER_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"

jobs:
  create-pr:
    name: Create PR (${{ inputs.source_branch }} â†’ ${{ inputs.target_branch }})
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ inputs.repository || github.repository }}

      - name: Configure Git
        run: |
          git config user.name "${{ env.GIT_USER_NAME }}"
          git config user.email "${{ env.GIT_USER_EMAIL }}"

      - name: Create sync branch
        env:
          COMMIT_SHA: ${{ github.sha }}
          SOURCE_BRANCH: ${{ inputs.source_branch }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
        run: |
          git fetch origin "${SOURCE_BRANCH}"
          BRANCH="sync/${SOURCE_BRANCH}-to-${TARGET_BRANCH}-${COMMIT_SHA}"
          echo "BRANCH=${BRANCH}" >> $GITHUB_ENV

          if git ls-remote --heads origin "${BRANCH}" | grep -q .; then
            git fetch origin "${BRANCH}"
          fi
          git checkout -B "${BRANCH}" origin/${SOURCE_BRANCH}
          git push --force-with-lease origin "${BRANCH}"

      - name: Create Pull Request
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          SOURCE_BRANCH: ${{ inputs.source_branch }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          REPOSITORY: ${{ inputs.repository || github.repository }}
        run: |
          COMMIT_TITLE=$(printf '%s\n' "${COMMIT_MESSAGE}" \
            | sed -n '/[^[:space:]]/,$p' \
            | head -n 1 \
            | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
          [ -z "${COMMIT_TITLE}" ] && COMMIT_TITLE="(no commit title)"

          PR_TITLE="ðŸ”„ Sync ${SOURCE_BRANCH} to ${TARGET_BRANCH} - ${COMMIT_TITLE}"
          PR_TITLE="${PR_TITLE:0:256}"

          PR_BODY=$(cat <<EOF
## ðŸ”„ Sync \`${SOURCE_BRANCH}\` â†’ \`${TARGET_BRANCH}\`

This PR was automatically created to sync changes from \`${SOURCE_BRANCH}\` to \`${TARGET_BRANCH}\`.

**Source Commit:** \`${COMMIT_SHA}\`
**Commit Message:** ${COMMIT_MESSAGE}

### Action Required

1. Review the changed files
2. Resolve conflicts if any
3. Ensure CI passes
4. Merge this PR

---

ðŸ¤– Generated by [create-sync-branch-pr workflow](https://github.com/lepusinc/.github/blob/main/.github/workflows/create-sync-branch-pr.yml)
EOF
          )

          PR_URL=$(gh pr create \
            --repo "${REPOSITORY}" \
            --base "${TARGET_BRANCH}" \
            --head "${BRANCH}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}" \
            2>/tmp/pr_create_err.txt)
          CREATE_STATUS=$?

          if [ "${CREATE_STATUS}" -eq 0 ]; then
            echo "pull-request-url=${PR_URL}" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_CREATE_ERR=$(cat /tmp/pr_create_err.txt)
          if echo "${PR_CREATE_ERR}" | grep -q "already exists"; then
            echo "::notice::PR already exists for ${BRANCH}."
            PR_URL=$(gh pr view "${BRANCH}" --repo "${REPOSITORY}" --json url --jq '.url')
            echo "pull-request-url=${PR_URL}" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "::error::gh pr create failed (exit ${CREATE_STATUS}): ${PR_CREATE_ERR}"
          exit 1

      - name: Add labels to PR
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ steps.create_pr.outputs.pull-request-url }}
        run: |
          gh pr edit "${PR_URL}" --add-label "sync,automated" 2>&1 || \
            echo "::warning::Failed to add labels to PR: ${PR_URL}"

      - name: Output summary
        if: success()
        env:
          PR_URL: ${{ steps.create_pr.outputs.pull-request-url }}
          SOURCE_BRANCH: ${{ inputs.source_branch }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âœ… PR Created

          | | |
          |---|---|
          | **Source** | \`${SOURCE_BRANCH}\` |
          | **Target** | \`${TARGET_BRANCH}\` |
          | **PR** | ${PR_URL} |
          EOF

      - name: Output failure summary
        if: failure()
        env:
          SOURCE_BRANCH: ${{ inputs.source_branch }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âŒ PR Creation Failed

          | | |
          |---|---|
          | **Source** | \`${SOURCE_BRANCH}\` |
          | **Target** | \`${TARGET_BRANCH}\` |

          Please check the workflow logs for details.
          EOF
