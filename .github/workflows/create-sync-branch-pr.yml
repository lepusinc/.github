name: Create pull request to sync
run-name: Create pull request to sync. (${{ github.ref_name }} -> ${{ inputs.target_branch }})

on:
  workflow_call:
    inputs:
      target_branch:
        description: "ãƒžãƒ¼ã‚¸å…ˆãƒ–ãƒ©ãƒ³ãƒå"
        type: string
        required: true
  workflow_dispatch:
    inputs:
      target_branch:
        description: "ãƒžãƒ¼ã‚¸å…ˆãƒ–ãƒ©ãƒ³ãƒå"
        type: string
        required: true
        default: "test-sync-target"

permissions:
  contents: write
  pull-requests: write

jobs:
  workflow-template-artifact:
    name: Upload workflow template artifact
    runs-on: ubuntu-latest
    env:
      WORKFLOW_TEMPLATES_PATH: _workflow_templates
      ARTIFACT_NAME: workflow-templates
    outputs:
      name: ${{ env.ARTIFACT_NAME }}
    steps:
      - name: Extract template source
        id: extract_template_source
        env:
          WORKFLOW_REF: ${{ github.workflow_ref }}
        run: |
          TEMPLATE_REPOSITORY="${WORKFLOW_REF%%/.github/workflows/*}"
          TEMPLATE_REF="${WORKFLOW_REF##*@}"

          echo "### Template Source" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "```" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "repository=${TEMPLATE_REPOSITORY}" | tee -a "$GITHUB_OUTPUT" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "ref=${TEMPLATE_REF}" | tee -a "$GITHUB_OUTPUT" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "```" | tee -a "$GITHUB_STEP_SUMMARY"

      - name: Cache templates
        id: cache_templates
        uses: actions/cache@v5
        with:
          path: ${{ env.WORKFLOW_TEMPLATES_PATH }}
          key: workflow-templates-${{ github.workflow_sha }}

      - name: Cache Result
        id: cache_result
        env:
          CACHE_HIT: ${{ steps.cache_templates.outputs.cache-hit }}
          CACHE_PATH: ${{ env.WORKFLOW_TEMPLATES_PATH }}
        run: |
          echo "### Cache" | tee -a "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.cache_templates.outputs.cache-hit }}" = "true" ]; then
            echo "- Cache used" | tee -a "$GITHUB_STEP_SUMMARY"
          else
            echo "- Cache missed" | tee -a "$GITHUB_STEP_SUMMARY"
          fi

      - name: Checkout templates
        if: steps.cache_templates.outputs.cache-hit != 'true'
        uses: actions/checkout@v6
        with:
          repository: ${{ steps.extract_template_source.outputs.repository }}
          ref: ${{ steps.extract_template_source.outputs.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: ${{ env.WORKFLOW_TEMPLATES_PATH }}
          sparse-checkout: |
            .github/PULL_REQUEST_TEMPLATE
            .github/workflow-templates
          sparse-checkout-cone-mode: false

      - name: Upload Artifact
        id: upload_artifact
        uses: actions/upload-artifact@v7
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.WORKFLOW_TEMPLATES_PATH }}
          include-hidden-files: true
          retention-days: 1

      - name: Upload Artifact Result
        run: |
          echo "### Artifact" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "- Artifact ID: ${{ steps.upload_artifact.outputs.artifact-id }}" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "- Download URL: ${{ steps.upload_artifact.outputs.artifact-url }}" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "- SHA256 digest: ${{ steps.upload_artifact.outputs.artifact-digest }}" | tee -a "$GITHUB_STEP_SUMMARY"

          echo "## Output" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "name=${{ env.ARTIFACT_NAME }}" | tee -a "$GITHUB_OUTPUT" | tee -a "$GITHUB_STEP_SUMMARY"

  create-pr:
    name: Create pull request
    runs-on: ubuntu-latest
    needs: workflow-template-artifact
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          repository: ${{ github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download workflow templates
        id: download_templates
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.workflow-template-artifact.outputs.name }}
          path: _workflow_templates

      - name: Create sync branch
        id: create_sync_branch
        env:
          COMMIT_SHA: ${{ github.sha }}
          SOURCE_BRANCH: ${{ github.ref_name }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          BRANCH: "sync/${{ github.ref_name }}-to-${{ inputs.target_branch }}-${{ github.sha }}"
        run: |
          git fetch origin "${SOURCE_BRANCH}"

          if git ls-remote --heads origin "${BRANCH}" | grep -q .; then
          git fetch origin "${BRANCH}"
          fi
          git checkout -B "${BRANCH}" origin/${SOURCE_BRANCH}
          git push --force-with-lease origin "${BRANCH}"

          echo "branch=${BRANCH}" | tee -a "$GITHUB_OUTPUT"

      - name: Check Existing PR
        id: check_existing_pr
        env:
          BRANCH: ${{ steps.create_sync_branch.outputs.branch }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING_PR=$(gh pr view "${BRANCH}" --repo "${{ github.repository }}" --json url --jq '.url' 2>/dev/null || true)
          if [ -n "${EXISTING_PR}" ]; then
            echo "::notice::PR already exists for ${BRANCH}: ${EXISTING_PR}"
            echo "pull-request-url=${EXISTING_PR}" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        id: create_pr
        if: steps.check_existing_pr.outputs.pull-request-url == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          SOURCE_BRANCH: ${{ github.ref_name }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          BRANCH: ${{ steps.create_sync_branch.outputs.branch }}
          TEMPLATES_PATH: ${{ steps.download_templates.outputs.download-path }}
        run: |
          COMMIT_TITLE=$(printf '%s\n' "${COMMIT_MESSAGE}" \
            | sed -n '/[^[:space:]]/,$p' \
            | head -n 1 \
            | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
          [ -z "${COMMIT_TITLE}" ] && COMMIT_TITLE="(no commit title)"

          PR_TITLE="ðŸ”„ Sync ${SOURCE_BRANCH} to ${TARGET_BRANCH} - ${COMMIT_TITLE}"
          PR_TITLE="${PR_TITLE:0:256}"

          PR_BODY=$(envsubst < "$TEMPLATES_PATH/.github/PULL_REQUEST_TEMPLATE/sync.md")

          PR_URL=$(gh pr create \
            --repo "${{ github.repository }}" \
            --base "${TARGET_BRANCH}" \
            --head "${BRANCH}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}")
          echo "pull-request-url=${PR_URL}" >> $GITHUB_OUTPUT

      - name: Add labels to PR
        id: add_labels
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ steps.check_existing_pr.outputs.pull-request-url || steps.create_pr.outputs.pull-request-url }}
        run: |
          LABELS="sync,automated"
          LABEL_OUTPUT=$(gh pr edit "${PR_URL}" --add-label "${LABELS}" 2>&1) && LABEL_STATUS=0 || LABEL_STATUS=$?

          echo "labels=${LABELS}" >> $GITHUB_OUTPUT
          if [ "${LABEL_STATUS}" -eq 0 ]; then
            echo "label-status=success" >> $GITHUB_OUTPUT
          else
            echo "::warning::Failed to add labels to PR: ${PR_URL}"
            echo "label-status=failure" >> $GITHUB_OUTPUT
            {
              echo 'label-error<<LABEL_ERROR_EOF'
              echo "${LABEL_OUTPUT}"
              echo 'LABEL_ERROR_EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: Output summary
        if: success()
        env:
          SOURCE_BRANCH: ${{ github.ref_name }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          TEMPLATES_PATH: ${{ steps.download_templates.outputs.download-path }}
          PR_URL: ${{ steps.check_existing_pr.outputs.pull-request-url || steps.create_pr.outputs.pull-request-url }}
        run: |
          envsubst < "$TEMPLATES_PATH/.github/workflow-templates/pr-created.md" >> $GITHUB_STEP_SUMMARY

      - name: Output failure summary
        if: failure()
        env:
          SOURCE_BRANCH: ${{ github.ref_name }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          TEMPLATES_PATH: ${{ steps.download_templates.outputs.download-path }}
        run: |
          envsubst < "$TEMPLATES_PATH/.github/workflow-templates/pr-creation-failed.md" >> $GITHUB_STEP_SUMMARY
